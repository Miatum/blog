<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Miatum's blog</title>
    <script src="/js/jquery.min.js"></script>
    <script src="/layui/layui.js"></script>
    <link rel="icon" type="image/x-ico" href="/pic/logo.ico">
    <link rel="stylesheet" type="text/css" href="/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/css/manage.css">
</head>
<body>
<div>
    <header>
        <a class="logo" href="/">Miatum</a>
    </header>
    <nav>
        <ul class="layui-nav layui-nav-tree">
            <li class="layui-nav-item"><a href="/manageBlog">管理博客</a></li>
            <li class="layui-nav-item"><a href="/manageBlogType">博客类别</a></li>
            <li class="layui-nav-item"><a href="/manageBlogTag">博客标签</a></li>
            <li class="layui-nav-item"><a href="/manageUser">用户管理</a></li>
        </ul>
    </nav>
    <main>
        <fieldset class="layui-elem-field tool">
            <legend>tool</legend>
            <div>
                <button class="layui-btn layui-btn-primary" data-type="checkAndDelete">批量删除</button>
                <button class="layui-btn" data-method="addType">新增</button>
            </div>
        </fieldset>
        <table id="blogType" lay-filter="blogType"></table>
    </main>
</div>
<form id="add" class="layui-form" style="display: none" action="">
    <div class="layui-form-item">
        <label class="layui-form-label">分类名</label>
        <div class="layui-input-block">
            <input id="type_name" type="text" name="title" lay-verify="title" autocomplete="off" class="layui-input">
        </div>
        <label class="layui-form-label">分类英文名</label>
        <div class="layui-input-block">
            <input id="type_name_en" type="text" name="title" lay-verify="title" autocomplete="off" class="layui-input">
        </div>
    </div>
</form>
<script type="text/html" id="inline-bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
    layui.use('element', function(){
        var element = layui.element;
        element.on('nav()', function(elem){
            layer.msg(elem.text());
        });
    });
</script>
<script>
    layui.use('table', function(){
        var table = layui.table;
        table.render({
            elem: '#blogType'
            ,height: 600
            ,url: '/blog_Type_layuiTable'
            ,page: true
            ,cols: [
                [
                    {type:'checkbox', fixed: 'left'}
                    ,{field:"id",title: 'id',sort: true}
                    ,{field:"type_name",title: '分类名',edit: 'text'}
                    ,{field:"type_name_en",title: '分类英文名',edit: 'text'}
                    ,{fixed: 'right', title:'', toolbar: '#inline-bar', width:150}
                ]
            ]

        });
        table.on('tool()', function(obj) {
            var blog_type = obj.data;
            if (obj.event === 'del') {
                layer.confirm('确认删除', function (index) {
                    obj.del();
                    layer.close(index);
                    deleteBlog_Type(blog_type.id);
                });
            } else if (obj.event === 'edit') {
                layer.prompt({
                    formType: 2
                    , value: blog_type.type_name
                }, function (value, index) {
                    obj.update({
                        type_name: value
                    });
                    layer.close(index);
                    blog_type.type_name=value;
                    updateBlog_Type(blog_type);
                });
            }
        });
        table.on('edit(blogType)', function(obj){
            updateBlog_Type(obj.data);
        });
        var $ = layui.$; active = {
            checkAndDelete: function(){
                var checkStatus = table.checkStatus('blogType')
                    ,data = checkStatus.data;
                deleteBlog_Types(data);
                reload();
            }
        };
        $('.tool .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

    });
</script>
<script>
    layui.use('layer', function() {
        var $ = layui.jquery, layer = layui.layer;
        var active = {
            addType: function (othis) {
                var type = othis.data('type')
                    , text = othis.text();
                layer.open({
                    type: 1
                    , offset: type
                    , id: 'layerAdd' + type
                    , content: $('#add')
                    , btn: '提交'
                    , btnAlign: 'c' //按钮居中
                    , shade: 0 //不显示遮罩
                    , yes: function () {
                        var blog_type={id:null,type_name:$('#type_name').val(),type_name_en:$('#type_name_en').val()};
                        addBlog_Type(blog_type);
                        layer.closeAll();
                        reload();
                    }
                });
            }
        };
        $('.tool .layui-btn').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
    });
</script>
<script>
    function deleteBlog_Type(id) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/deleteBlog_Type?id='+id)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function deleteBlog_Types(types) {
        $.ajax({
            type : "POST",
            url : "/deleteBlog_Types",
            contentType : "application/json",
            dataType : "json",
            data : JSON.stringify(types),
            success : function (result) {
                console.log(result);
            },
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        })
    }
    function updateBlog_Type(blog_type) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/updateBlog_Type?id='+blog_type.id+
            '&type_name='+blog_type.type_name+'&type_name_en='+blog_type.type_name_en)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function addBlog_Type(blog_type) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/addBlog_Type?type_name='+blog_type.type_name+'&type_name_en='+blog_type.type_name_en)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function reload() {
        layui.use('table',function () {
            var table = layui.table;
            table.reload('blogType',function () {
                where:{}
                page:{
                    curr: 1
                }
            })
        })
    }
</script>

</body>
</html>