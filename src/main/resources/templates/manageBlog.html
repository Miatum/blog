<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Miatum's blog</title>
    <script src="/js/jquery.min.js"></script>
    <script src="/layui/layui.js"></script>
    <link rel="icon" type="image/x-ico" href="/pic/logo.ico">
    <link rel="stylesheet" type="text/css" href="/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/css/manage.css">
</head>
<body>
<div>
    <header>
        <a class="logo" href="/">Miatum</a>
    </header>
    <nav>
        <ul class="layui-nav layui-nav-tree">
            <li class="layui-nav-item"><a href="/manageBlog">管理博客</a></li>
            <li class="layui-nav-item"><a href="/manageBlogType">博客类别</a></li>
            <li class="layui-nav-item"><a href="/manageBlogTag">博客标签</a></li>
            <li class="layui-nav-item"><a href="/manageUser">用户管理</a></li>
        </ul>
    </nav>
    <main>
        <fieldset class="layui-elem-field tool">
            <legend>tool</legend>
            <div>
                <button class="layui-btn layui-btn-primary" data-type="checkAndDelete">批量删除</button>
                <button class="layui-btn" data-type="addBlog">新增</button>
            </div>
        </fieldset>
        <table id="blog"></table>
    </main>
</div>
<script type="text/html" id="inline-bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
    layui.use('element', function(){
        var element = layui.element;
    });
</script>
<script>
    layui.use('table', function(){
        var table = layui.table;
        table.render({
            elem: '#blog'
            ,height: 600
            ,url: '/selectAllBlog_layuiTable' //数据接口
            ,page: true
            ,cols: [
                [
                    {type:'checkbox', fixed: 'left'}
                    ,{field:"id",title: 'ID',sort: true}
                    ,{field:"title",title: '标题'}
                    ,{field:"intro",title: '摘要'}
                    ,{field:"cover",title: '封面图片'}
                    ,{field:"author",title: '作者'}
                    ,{field:"type_name",title: '分类',sort: true,}
                    ,{field:"tag_name",title: '标签',sort: true,}
                    ,{field:"date",title: '日期',sort: true}
                    ,{field:"content",title: '内容'}
                    ,{fixed: 'right', title:'', toolbar: '#inline-bar', width:150}
                ]
            ]

        });
        table.on('rowDouble()',function (obj) {
            window.location.href = '/editBlog/' + obj.data.id + '';
        })
        table.on('tool()', function(obj) {
            var blog = obj.data;
            if (obj.event === 'del') {
                layer.confirm('确认删除', function (index) {
                    obj.del();
                    layer.close(index);
                    deleteBlog(blog.id);
                });
            }else if (obj.event === 'edit') {
                window.location.href = '/editBlog/' + blog.id + '';
            }
        });
        var $ = layui.$, active = {
            checkAndDelete: function(){
                var checkStatus = table.checkStatus('blog')
                    ,data = checkStatus.data;
                deleteBlogs(data);
                reload();
            },
            addBlog: function () {
                window.location.href='/addBlog';
            }
        };
        $('.tool .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<script>
    function deleteBlog(id){
        /**
         *@Author: miatum
         *@Description: 单条删除博客
         *@Date: 23:01 2020/9/28
         */
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/deleteBlog?id='+id) // 设置请求行
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function deleteBlogs(blogs) {
        /**
        *@Author: miatum
        *@Description: 批量删除博客
        *@Date: 23:34 2020/10/7
        */
        $.ajax({
            type : "POST",
            url : "/deleteBlogs",
            contentType : "application/json",
            dataType : "json",
            data : JSON.stringify(blogs),
            success : function (result) {
                console.log(result);
            },
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        })
    }
    function reload() {
        layui.use('table',function () {
            var table = layui.table;
            table.reload('blog',function () {
                where:{}
                page:{
                    curr: 1
                }
            })
        })
    }
</script>
</body>
</html>