<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>Miatum's blog</title>
    <script src="/js/jquery.min.js"></script>
    <script src="/layui/layui.js"></script>
    <link rel="icon" type="image/x-ico" href="/pic/logo.ico">
    <link rel="stylesheet" type="text/css" href="/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" href="/css/manage.css">
</head>
<body>
<div>
    <header>
        <a class="logo" href="/">Miatum</a>
    </header>
    <nav>
        <ul class="layui-nav layui-nav-tree">
            <li class="layui-nav-item"><a href="/manageBlog">管理博客</a></li>
            <li class="layui-nav-item"><a href="/manageBlogType">博客类别</a></li>
            <li class="layui-nav-item"><a href="/manageBlogTag">博客标签</a></li>
            <li class="layui-nav-item"><a href="/manageUser">用户管理</a></li>
        </ul>
    </nav>
    <main>
        <fieldset class="layui-elem-field tool">
            <legend>tool</legend>
            <div>
                <button class="layui-btn layui-btn-primary" data-type="checkAndDelete">批量删除</button>
                <button class="layui-btn" data-method="addTag">新增</button>
            </div>
        </fieldset>
        <table id="blogTag" lay-filter="blogTag"></table>
    </main>
    <form id="add" class="layui-form" style="display: none" action="">
        <div class="layui-form-item">
            <label class="layui-form-label">标签名</label>
            <div class="layui-input-block">
                <input id="tag_name" type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标签名" class="layui-input">
            </div>
        </div>
    </form>
</div>
<script type="text/html" id="inline-bar">
    <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>
<script>
    layui.use('element', function(){
        var element = layui.element;
        element.on('nav(demo)', function(elem){
            layer.msg(elem.text());
        });
    });
</script>
<script>
    layui.use('table', function(){
        var table = layui.table;
        table.render({
            elem: '#blogTag'
            ,height: 600
            ,url: '/blog_Tag_layuiTable'
            ,page: true
            ,cols: [
                [
                    {type:'checkbox', fixed: 'left'}
                    ,{field:"id",title: 'id',sort: true}
                    ,{field:"tag_name",title: '标签名',edit: 'text'}
                    ,{fixed: 'right', title:'', toolbar: '#inline-bar', width:150}
                ]
            ]

        });
        table.on('tool(blogTag)', function(obj) {
            var blog_tag = obj.data;
            if (obj.event === 'del') {
                layer.confirm('确认删除', function (index) {
                    obj.del();
                    layer.close(index);
                    deleteBlog_Tag(blog_tag.id);
                });
            } else if (obj.event === 'edit') {
                layer.prompt({
                    formType: 2
                    , value: blog_tag.tag_name
                }, function (value, index) {
                    obj.update({
                        tag_name: value
                    });
                    layer.close(index);
                    blog_tag.tag_name=value;
                    updateBlog_Tag(blog_tag);
                });
            }
        });
        var $ = layui.$; active = {
            checkAndDelete: function(){
                var checkStatus = table.checkStatus('blogTag')
                    ,data = checkStatus.data;
                deleteBlog_Tags(data);
                reload();
            }
        };
        $('.tool .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });
    });
</script>
<script>
    function deleteBlog_Tag(id) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/deleteBlog_Tag?id='+id)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function deleteBlog_Tags(tags) {
        $.ajax({
            type : "POST",
            url : "/deleteBlog_Tags",
            contentType : "application/json",
            dataType : "json",
            data : JSON.stringify(tags),
            success : function (result) {
                console.log(result);
            },
            error : function(e){
                console.log(e.status);
                console.log(e.responseText);
            }
        })
    }
    function updateBlog_Tag(blog_tag) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/updateBlog_Tag?id='+blog_tag.id+
            '&tag_name='+blog_tag.tag_name)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function addBlog_Tag(blog_tag) {
        var xhr = new XMLHttpRequest()
        xhr.open('GET', '/addBlog_Tag?tag_name='+blog_tag.tag_name)
        xhr.send()
        xhr.onload=function(){
            if(xhr.readyState!==4) return
            console.log(xhr.responseText)
        }
    }
    function reload() {
        layui.use('table',function () {
            var table = layui.table;
            table.reload('blogTag',function () {
                where:{}
                page:{
                    curr: 1
                }
            })
        })
    }
</script>
<script>
    /**
     *@Author: miatum
     *@Description: 弹出层，用于新增标签
     *@Date: 2:41 2020/9/30
     */
    layui.use('layer', function() {
        var $ = layui.jquery, layer = layui.layer;
        var active = {
            addTag: function (othis) {
                var type = othis.data('type')
                    , text = othis.text();
                layer.open({
                    type: 1
                    , offset: type
                    , id: 'layerDemo' + type
                    , content: $('#add')
                    , btn: '提交'
                    , btnAlign: 'c' //按钮居中
                    , shade: 0 //不显示遮罩
                    , yes: function () {
                        var blog_tag={'id':null,tag_name:$('#tag_name').val()};
                        addBlog_Tag(blog_tag);
                        layer.closeAll();
                        reload();
                    }
                });
            }
        };
        $('.tool .layui-btn').on('click', function () {
            var othis = $(this), method = othis.data('method');
            active[method] ? active[method].call(this, othis) : '';
        });
    });
</script>
</body>
</html>